<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VideoCall App - Usuarios</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; height: 100vh; overflow: hidden; }
    .header { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); padding: 1.2rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .header-content { display: flex; align-items: center; gap: 1rem; }
    .logo { font-size: 1.8rem; background: linear-gradient(135deg, #ff6b6b, #feca57); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .header h1 { font-size: 1.5rem; font-weight: 600; }
    .welcome-text { opacity: 0.9; font-weight: 300; }
    .logout { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; padding: 10px 20px; border-radius: 10px; text-decoration: none; font-weight: 500; transition: all 0.3s ease; border: 1px solid rgba(255, 107, 107, 0.3); }
    .logout:hover { background: rgba(255, 107, 107, 0.3); transform: translateY(-2px); }
    .container { padding: 2rem; height: calc(100vh - 80px); overflow-y: auto; }
    .section-title { font-size: 1.8rem; margin-bottom: 1.5rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
    .users-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; }
    .user-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border-radius: 20px; padding: 1.5rem; text-align: center; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.1); position: relative; overflow: hidden; }
    .user-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(135deg, #4facfe, #00f2fe); }
    .user-card:hover { transform: translateY(-8px); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2); background: rgba(255, 255, 255, 0.15); }
    .user-card .avatar { width: 80px; height: 80px; background: linear-gradient(135deg, #4facfe, #00f2fe); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 2rem; box-shadow: 0 8px 20px rgba(79, 172, 254, 0.3); }
    .user-card h3 { font-size: 1.2rem; margin-bottom: 0.5rem; font-weight: 600; }
    .status { display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem; }
    .status-dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .call-buttons { display: flex; gap: 0.8rem; justify-content: center; }
    .call-btn { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
    .audio { background: linear-gradient(135deg, #10b981, #34d399); }
    .video { background: linear-gradient(135deg, #3b82f6, #60a5fa); }
    .call-btn:hover { transform: scale(1.1) translateY(-2px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }

    #incoming-call { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(30px); padding: 2.5rem; border-radius: 24px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3); display: none; flex-direction: column; align-items: center; gap: 1.5rem; z-index: 1000; border: 1px solid rgba(255, 255, 255, 0.2); text-align: center; max-width: 400px; width: 90%; animation: modalAppear 0.4s ease; }
    @keyframes modalAppear { from { opacity: 0; transform: translate(-50%, -60%); } to { opacity: 1; transform: translate(-50%, -50%); } }
    .caller-avatar { width: 100px; height: 100px; background: linear-gradient(135deg, #f59e0b, #fbbf24); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem; }
    .call-type { font-size: 1.1rem; opacity: 0.9; margin-bottom: 0.5rem; }
    .call-buttons-modal { display: flex; gap: 1rem; margin-top: 1rem; }
    .call-buttons-modal button { padding: 12px 30px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
    .accept { background: linear-gradient(135deg, #10b981, #34d399); color: white; }
    .accept:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4); }
    .reject { background: linear-gradient(135deg, #ef4444, #f87171); color: white; }
    .reject:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4); }

    .call-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e293b, #0f172a); display: none; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 999; }
    .video-container { position: relative; width: 90%; max-width: 1000px; margin-bottom: 2rem; }
    #remote-video { width: 100%; border-radius: 16px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); }
    #local-video { position: absolute; bottom: 20px; right: 20px; width: 200px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); border: 2px solid rgba(255, 255, 255, 0.3); }
    .audio-call-container { text-align: center; padding: 3rem; }
    .audio-avatar { width: 150px; height: 150px; background: linear-gradient(135deg, #8b5cf6, #a78bfa); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 3.5rem; font-weight: 700; margin: 0 auto 2rem; box-shadow: 0 15px 40px rgba(139, 92, 246, 0.4); animation: pulse 2s infinite; }
    .call-info { text-align: center; margin-bottom: 2rem; }
    .call-status { font-size: 1.3rem; margin-bottom: 0.5rem; font-weight: 600; }
    .call-timer { font-size: 2rem; font-weight: 700; background: linear-gradient(135deg, #4facfe, #00f2fe); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem; }
    .call-controls { display: flex; gap: 1.5rem; justify-content: center; }
    .control-btn { width: 60px; height: 60px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.3rem; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
    .hangup { background: linear-gradient(135deg, #ef4444, #f87171); }
    .hangup:hover { transform: scale(1.1); box-shadow: 0 12px 30px rgba(239, 68, 68, 0.4); }
    .mute { background: linear-gradient(135deg, #6b7280, #9ca3af); }
    .mute:hover { transform: scale(1.1); }
    .empty-state { text-align: center; padding: 4rem 2rem; opacity: 0.7; }
    .empty-state i { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }

    .audio-indicator { display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 1rem 0; }
    .audio-bars { display: flex; gap: 3px; align-items: end; height: 30px; }
    .audio-bar { width: 4px; background: linear-gradient(135deg, #4facfe, #00f2fe); border-radius: 2px; }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="logo"><i class="fas fa-video"></i></div>
      <div>
        <h1>VideoCall App</h1>
        <div class="welcome-text">¡Hola, {{ username }}!</div>
      </div>
    </div>
    <a href="/logout" class="logout"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</a>
  </div>

  <div class="container">
    <"h2 class="section-title"><i class="fas fa-users"></i> Usuarios en línea</h2>
    <div class="users-grid" id="users-grid">
      <div class="empty-state" id="empty-state">
        <i class="fas fa-user-friends"></i>
        <h3>No hay usuarios en línea</h3>
        <p>Espera a que otros usuarios se conecten</p>
      </div>
    </div>
  </div>

  <!-- Llamada entrante -->
  <div id="incoming-call">
    <div class="caller-avatar" id="caller-avatar"></div>
    <h3 id="caller-name">Llamada entrante</h3>
    <div class="call-type" id="call-type"></div>
    <div class="call-buttons-modal">
      <button class="accept" onclick="answerCall(true)"><i class="fas fa-phone"></i> Aceptar</button>
      <button class="reject" onclick="answerCall(false)"><i class="fas fa-phone-slash"></i> Rechazar</button>
    </div>
  </div>

  <!-- Audio Call -->
  <div id="audio-call" class="call-screen">
    <div class="audio-call-container">
      <div class="audio-avatar" id="audio-avatar"></div>
      <div class="call-info">
        <div class="call-status">Llamada de audio con</div>
        <div class="call-timer" id="audio-timer">00:00</div>
        <h2 id="audio-callee">Usuario</h2>
        <div class="audio-indicator">
          <div class="audio-bars">
            <div class="audio-bar" style="height:8px"></div>
            <div class="audio-bar" style="height:15px"></div>
            <div class="audio-bar" style="height:20px"></div>
            <div class="audio-bar" style="height:15px"></div>
            <div class="audio-bar" style="height:8px"></div>
          </div>
          <span>Transmitiendo audio...</span>
        </div>
      </div>
      <div class="call-controls">
        <button class="control-btn mute" onclick="toggleMute()"><i class="fas fa-microphone"></i></button>
        <button class="control-btn hangup" onclick="endCall()"><i class="fas fa-phone-slash"></i></button>
      </div>
    </div>
  </div>

  <!-- Video Call -->
  <div id="video-call" class="call-screen">
    <div class="video-container">
      <video id="remote-video" autoplay playsinline></video>
      <video id="local-video" autoplay playsinline muted></video>
    </div>
    <div class="call-info">
      <div class="call-status">Videollamada con</div>
      <div class="call-timer" id="video-timer">00:00</div>
      <h2 id="video-callee">Usuario</h2>
    </div>
    <div class="call-controls">
      <button class="control-btn mute" onclick="toggleMute()"><i class="fas fa-microphone"></i></button>
      <button class="control-btn hangup" onclick="endCall()"><i class="fas fa-phone-slash"></i></button>
    </div>
  </div>

  <script>
    const socket = io();
    const username = "{{ username }}";
    let currentCall = null;
    let peerConnection = null;
    let localStream = null;
    let remoteStream = null;
    let callStartTime = null;
    let callTimerInterval = null;
    let isMuted = false;
    let audioContext = null;
    let audioAnalyser = null;
    let callTimeout = null;

    // Enviar username al conectar
    socket.emit('user_connected', { username });

    socket.on('connect', () => console.log("Conectado"));
    socket.on('force_disconnect', () => {
      showNotification('Sesión cerrada desde otro dispositivo', 'error');
      setTimeout(() => window.location.href = '/logout', 2000);
    });

    socket.on('online_users', (data) => renderUsers(data.users));
    socket.on('user_online', (data) => addUser(data.username));
    socket.on('user_offline', (data) => removeUser(data.username));
    socket.on('incoming_call', (data) => {
      currentCall = data;
      document.getElementById('caller-avatar').textContent = data.caller[0].toUpperCase();
      document.getElementById('caller-name').textContent = data.caller;
      document.getElementById('call-type').textContent = data.type === 'audio' ? 'Llamada de audio' : 'Videollamada';
      document.getElementById('incoming-call').style.display = 'flex';
    });
    socket.on('call_responded', (data) => {
      if (!data.accepted) {
        showNotification(`${data.callee} rechazó la llamada`, 'error');
        endCall();
      } else {
        startCall(currentCall.type, data.callee);
      }
    });
    socket.on('webrtc_signal', (data) => handleSignal(data));

    function renderUsers(users) {
      const grid = document.getElementById('users-grid');
      const empty = document.getElementById('empty-state');
      const others = users.filter(u => u !== username);
      empty.style.display = others.length === 0 ? 'block' : 'none';
      grid.innerHTML = '';
      others.forEach(addUser);
    }

    function addUser(user) {
      if (user === username || document.querySelector(`[data-user="${user}"]`)) return;
      const card = document.createElement('div');
      card.className = 'user-card';
      card.dataset.user = user;
      card.innerHTML = `
        <div class="avatar">${user[0].toUpperCase()}</div>
        <h3>${user}</h3>
        <div class="status"><div class="status-dot"></div> En línea</div>
        <div class="call-buttons">
          <div class="call-btn audio" onclick="initiateCall('${user}', 'audio')"><i class="fas fa-phone"></i></div>
          <div class="call-btn video" onclick="initiateCall('${user}', 'video')"><i class="fas fa-video"></i></div>
        </div>
      `;
      document.getElementById('users-grid').appendChild(card);
    }

    function removeUser(user) {
      const card = document.querySelector(`.user-card[data-user="${user}"]`);
      if (card) card.remove();
      if (!document.querySelector('.user-card')) document.getElementById('empty-state').style.display = 'block';
    }

    function initiateCall(callee, type) {
      if (currentCall) return showNotification('Ya estás en una llamada', 'error');
      currentCall = { callee, type, caller: username };
      socket.emit('call_user', { callee, type });
      showNotification(`Llamando a ${callee}...`, 'info');

      callTimeout = setTimeout(() => {
        if (currentCall) {
          showNotification(`${callee} no respondió`, 'error');
          endCall();
        }
      }, 15000);
    }

    function answerCall(accepted) {
      clearTimeout(callTimeout);
      document.getElementById('incoming-call').style.display = 'none';
      socket.emit('answer_call', { caller: currentCall.caller, accepted });
      if (accepted) startCall(currentCall.type, currentCall.caller);
      else showNotification('Llamada rechazada', 'info');
      currentCall = null;
    }

    async function startCall(type, peer) {
      document.getElementById(type + '-call').style.display = 'flex';
      document.getElementById(type + '-callee').textContent = peer;
      if (type === 'audio') document.getElementById('audio-avatar').textContent = peer[0].toUpperCase();

      callStartTime = new Date();
      startCallTimer(type);

      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          video: type === 'video' ? { width: 1280, height: 720 } : false,
          audio: true
        });
        if (type === 'video') document.getElementById('local-video').srcObject = localStream;
        else setupAudioAnalysis();

        peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));

        remoteStream = new MediaStream();
        peerConnection.ontrack = (e) => {
          e.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));
          if (type === 'video') document.getElementById('remote-video').srcObject = remoteStream;
          else {
            const audio = new Audio(); audio.srcObject = remoteStream; audio.autoplay = true; audio.style.display = 'none';
            document.body.appendChild(audio);
          }
        };

        peerConnection.onicecandidate = (e) => e.candidate && socket.emit('webrtc_signal', { target: peer, candidate: e.candidate });

        if (currentCall.caller === username) {
          const offer = await peerConnection.createOffer();
          await peerConnection.setLocalDescription(offer);
          socket.emit('webrtc_signal', { target: peer, sdp: peerConnection.localDescription });
        }
      } catch (err) {
        showNotification('Error de cámara/micrófono', 'error');
        endCall();
      }
    }

    async function handleSignal(data) {
      if (!peerConnection) return;
      try {
        if (data.sdp) {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
          if (data.sdp.type === 'offer') {
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('webrtc_signal', { target: data.sender, sdp: peerConnection.localDescription });
          }
        } else if (data.candidate) {
          await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
      } catch (err) { console.error(err); }
    }

    function setupAudioAnalysis() {
      audioContext = new AudioContext();
      audioAnalyser = audioContext.createAnalyser();
      const source = audioContext.createMediaStreamSource(localStream);
      source.connect(audioAnalyser);
      audioAnalyser.fftSize = 256;
      animateAudioBars();
    }

    function animateAudioBars() {
      if (!audioAnalyser) return;
      const data = new Uint8Array(audioAnalyser.frequencyBinCount);
      audioAnalyser.getByteFrequencyData(data);
      document.querySelectorAll('.audio-bar').forEach((bar, i) => {
        const v = data[i * 10] || 0;
        bar.style.height = `${Math.max(5, (v / 255) * 30)}px`;
      });
      requestAnimationFrame(animateAudioBars);
    }

    function startCallTimer(type) {
      const el = document.getElementById(type + '-timer');
      callTimerInterval = setInterval(() => {
        const diff = Math.floor((new Date() - callStartTime) / 1000);
        const m = String(Math.floor(diff / 60)).padStart(2, '0');
        const s = String(diff % 60).padStart(2, '0');
        el.textContent = `${m}:${s}`;
      }, 1000);
    }

    function toggleMute() {
      if (localStream) {
        localStream.getAudioTracks().forEach(t => t.enabled = !t.enabled);
        isMuted = !isMuted;
        const icon = document.querySelector('.mute i');
        icon.className = isMuted ? 'fas fa-microphone-slash' : 'fas fa-microphone';
        showNotification(isMuted ? 'Micrófono silenciado' : 'Micrófono activado', 'info');
      }
    }

    function endCall() {
      if (peerConnection) { peerConnection.close(); peerConnection = null; }
      if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
      if (callTimerInterval) { clearInterval(callTimerInterval); callTimerInterval = null; }
      if (audioContext) { audioContext.close(); audioContext = null; }
      clearTimeout(callTimeout);
      document.querySelectorAll('audio[style*="display: none"]').forEach(a => a.remove());
      document]=
      document.getElementById('audio-call').style.display = 'none';
      document.getElementById('video-call').style.display = 'none';
      currentCall = null; isMuted = false;
      showNotification('Llamada finalizada', 'info');
    }

    function showNotification(msg, type) {
      const n = document.createElement('div');
      n.style.cssText = `position:fixed;top:20px;right:20px;padding:1rem 1.5rem;border-radius:12px;color:white;font-weight:500;z-index:2000;animation:slideInRight .3s ease;background:${type==='error'?'linear-gradient(135deg,#ef4444,#f87171)':type==='info'?'linear-gradient(135deg,#3b2f6,#60a5fa)':'linear-gradient(135deg,#10b981,#34d399)'};box-shadow:0 8px 25px rgba(0,0,0,.3)`;
      n.textContent = msg;
      document.body.appendChild(n);
      setTimeout(() => { n.style.animation = 'slideOutRight .3s ease'; setTimeout(() => n.remove(), 300); }, 3000);
    }

    const style = document.createElement('style');
    style.textContent = `@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }`;
    document.head.appendChild(style);
  </script>
</body>
</html>