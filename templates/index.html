<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Usuarios</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: #f0f7ff;
      color: #1e3a8a;
      height: 100vh;
      overflow: hidden;
    }
    .header {
      background: #1e3a8a;
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 1.4rem; font-weight: 500; }
    .logout { color: #fca5a5; text-decoration: none; font-weight: 500; }
    .container { padding: 1.5rem; }
    .users-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .user-card {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: 0.3s;
    }
    .user-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); }
    .user-card .avatar {
      width: 60px; height: 60px;
      background: #60a5fa;
      border-radius: 50%;
      margin: 0 auto 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1.5rem;
    }
    .user-card h3 { font-size: 1rem; margin-bottom: 0.5rem; }
    .call-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-top: 0.5rem;
    }
    .call-btn {
      width: 36px; height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: 0.3s;
    }
    .audio { background: #10b981; }
    .video { background: #3b82f6; }
    .call-btn:hover { transform: scale(1.1); }

    /* Modal de llamada entrante */
    #incoming-call {
      position: fixed;
      top: 20px; left: 50%;
      transform: translateX(-50%);
      background: #1e3a8a;
      color: white;
      padding: 1rem 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      display: none;
      align-items: center;
      gap: 1rem;
      z-index: 1000;
      animation: slideDown 0.4s ease;
    }
    @keyframes slideDown {
      from { transform: translate(-50%, -100px); opacity: 0; }
      to { transform: translateX(-50%); opacity: 1; }
    }
    #incoming-call button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    .accept { background: #10b981; color: white; }
    .reject { background: #ef4444; color: white; }

    /* Pantallas de llamada */
    .call-screen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #000;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      z-index: 999;
    }
    .call-screen video {
      width: 100%;
      max-width: 800px;
      border-radius: 12px;
      margin-bottom: 1rem;
    }
    .call-controls {
      display: flex;
      gap: 1rem;
    }
    .hangup {
      background: #ef4444;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 50px;
      font-size: 1.1rem;
      cursor: pointer;
    }
    .status { margin: 1rem 0; font-size: 1.2rem; }
  </style>
</head>
<body>
  <div class="header">
    <h1>¡Hola, {{ username }}!</h1>
    <a href="/logout" class="logout">Cerrar sesión</a>
  </div>

  <div class="container">
    <h2>Usuarios en línea</h2>
    <div class="users-grid" id="users-grid"></div>
  </div>

  <!-- Llamada entrante -->
  <div id="incoming-call">
    <span id="caller-name"></span>
    <button class="accept" onclick="answerCall(true)">Aceptar</button>
    <button class="reject" onclick="answerCall(false)">Rechazar</button>
  </div>

  <!-- Pantalla de audio -->
  <div id="audio-call" class="call-screen">
    <div class="status">Llamada de audio con <span id="audio-callee"></span></div>
    <div class="call-controls">
      <button class="hangup" onclick="endCall()">Colgar</button>
    </div>
  </div>

  <!-- Pantalla de video -->
  <div id="video-call" class="call-screen">
    <video id="remote-video" autoplay playsinline></video>
    <video id="local-video" autoplay playsinline muted style="width: 200px; position: absolute; bottom: 20px; right: 20px; border-radius: 12px;"></video>
    <div class="status">Videollamada con <span id="video-callee"></span></div>
    <div class="call-controls">
      <button class="hangup" onclick="endCall()">Colgar</button>
    </div>
  </div>

  <script>
    const socket = io();
    const username = "{{ username }}";
    let currentCall = null;
    let peerConnection = null;
    let localStream = null;

    socket.on('connect', () => {
      console.log("Conectado al servidor");
    });

    socket.on('online_users', (data) => {
      renderUsers(data.users);
    });

    socket.on('user_online', (data) => {
      addUser(data.username);
    });

    socket.on('user_offline', (data) => {
      removeUser(data.username);
    });

    socket.on('incoming_call', (data) => {
      currentCall = data;
      document.getElementById('caller-name').textContent = `${data.caller} te llama (${data.type})`;
      document.getElementById('incoming-call').style.display = 'flex';
    });

    socket.on('call_responded', (data) => {
      if (!data.accepted) {
        alert(`${data.callee} rechazó la llamada`);
        endCall();
      } else {
        startCall(currentCall.type, data.callee);
      }
    });

    socket.on('webrtc_signal', (data) => {
      handleSignal(data);
    });

    function renderUsers(users) {
      const grid = document.getElementById('users-grid');
      grid.innerHTML = '';
      users.forEach(u => {
        if (u !== username) addUser(u);
      });
    }

    function addUser(user) {
      if (user === username) return;
      const grid = document.getElementById('users-grid');
      if ([...grid.children].some(c => c.dataset.user === user)) return;

      const card = document.createElement('div');
      card.className = 'user-card';
      card.dataset.user = user;
      card.innerHTML = `
        <div class="avatar">${user[0].toUpperCase()}</div>
        <h3>${user}</h3>
        <div class="call-buttons">
          <div class="call-btn audio" onclick="initiateCall('${user}', 'audio')">
            <i class="fas fa-phone"></i>
          </div>
          <div class="call-btn video" onclick="initiateCall('${user}', 'video')">
            <i class="fas fa-video"></i>
          </div>
        </div>
      `;
      grid.appendChild(card);
    }

    function removeUser(user) {
      const card = document.querySelector(`.user-card[data-user="${user}"]`);
      if (card) card.remove();
    }

    function initiateCall(callee, type) {
      currentCall = { callee, type };
      socket.emit('call_user', { callee, type });
      document.getElementById('incoming-call').style.display = 'none';
      setTimeout(() => {
        if (currentCall) startCall(type, callee);
      }, 1000);
    }

    function answerCall(accepted) {
      document.getElementById('incoming-call').style.display = 'none';
      socket.emit('answer_call', {
        caller: currentCall.caller,
        accepted
      });
      if (accepted) {
        startCall(currentCall.type, currentCall.caller);
      }
      currentCall = null;
    }

    async function startCall(type, peer) {
      document.getElementById(type + '-call').style.display = 'flex';
      document.getElementById(type + '-callee').textContent = peer;

      if (type === 'video') {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('local-video').srcObject = localStream;
      } else {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      }

      peerConnection = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
      });

      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.ontrack = (event) => {
        if (type === 'video') {
          document.getElementById('remote-video').srcObject = event.streams[0];
        }
      };

      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit('webrtc_signal', {
            target: peer,
            candidate: event.candidate
          });
        }
      };

      if (currentCall && currentCall.caller === username) {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit('webrtc_signal', {
          target: peer,
          sdp: peerConnection.localDescription
        });
      }
    }

    async function handleSignal(data) {
      if (!peerConnection) return;

      if (data.sdp) {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
        if (data.sdp.type === 'offer') {
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          socket.emit('webrtc_signal', {
            target: data.sender || currentCall.caller,
            sdp: peerConnection.localDescription
          });
        }
      } else if (data.candidate) {
        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    }

    function endCall() {
      if (peerConnection) peerConnection.close();
      if (localStream) localStream.getTracks().forEach(t => t.stop());
      document.getElementById('audio-call').style.display = 'none';
      document.getElementById('video-call').style.display = 'none';
      document.getElementById('remote-video').srcObject = null;
      document.getElementById('local-video').srcObject = null;
      peerConnection = null;
      localStream = null;
      currentCall = null;
    }

    // Inicialización
    socket.emit('connect');
  </script>
</body>
</html>