<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llamadas de Audio Real</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .screen {
            width: 100%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        #loginScreen {
            display: block;
            text-align: center;
        }

        .avatar-selection {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .avatar-option {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .avatar-option.selected {
            border-color: #4CAF50;
            transform: scale(1.1);
        }

        input {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            background: #4CAF50;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        button.secondary {
            background: #2196F3;
        }

        button.danger {
            background: #F44336;
        }

        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .user-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px);
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .call-display {
            text-align: center;
            margin: 30px 0;
        }

        .call-timer {
            font-size: 3rem;
            font-weight: 300;
            margin: 20px 0;
        }

        .call-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }

        .control-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn.active {
            background: #2196F3;
            color: white;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
        }

        .notification-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            background: #4CAF50;
        }

        .status.offline {
            background: #F44336;
        }

        #localAudio, #remoteAudio {
            width: 100%;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Llamadas de Audio Real</h1>
            <p>Conecta con audio de alta calidad en tiempo real</p>
        </header>

        <!-- Pantalla de Login -->
        <div id="loginScreen" class="screen">
            <h2>Configura tu perfil</h2>
            <div class="avatar-selection">
                <div class="avatar-option selected" data-avatar=""></div>
                <div class="avatar-option" data-avatar=""></div>
                <div class="avatar-option" data-avatar=""></div>
                <div class="avatar-option" data-avatar=""></div>
            </div>
            <input type="text" id="userName" placeholder="Ingresa tu nombre" maxlength="20">
            <button onclick="registerUser()">Entrar a la Sala</button>
        </div>

        <!-- Pantalla de Usuarios -->
        <div id="usersScreen" class="screen">
            <h2>Usuarios Conectados</h2>
            <div id="usersList" class="user-list">
                <!-- Los usuarios se cargar谩n aqu铆 -->
            </div>
            <button onclick="logout()" class="secondary">Salir</button>
        </div>

        <!-- Pantalla de Llamada -->
        <div id="callScreen" class="screen">
            <div class="call-display">
                <h2 id="callStatus">Llamando...</h2>
                <div class="call-timer" id="callTimer">00:00</div>
                <div id="callerInfo"></div>
            </div>
            
            <audio id="localAudio" muted></audio>
            <audio id="remoteAudio" autoplay></audio>
            
            <div class="call-controls">
                <button class="control-btn" id="muteBtn" onclick="toggleMute()"></button>
                <button class="control-btn" id="hangupBtn" onclick="endCall()"></button>
            </div>
        </div>

        <!-- Notificaci贸n de Llamada Entrante -->
        <div id="incomingCallNotification" class="notification">
            <h3>Llamada entrante</h3>
            <p id="callerName"></p>
            <div class="notification-buttons">
                <button onclick="acceptCall()" class="secondary">Aceptar</button>
                <button onclick="rejectCall()" class="danger">Rechazar</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Variables globales
        let socket;
        let localStream;
        let remoteStream;
        let peerConnection;
        let currentUser;
        let currentCall = null;
        let callStartTime;
        let timerInterval;
        let selectedAvatar = '';

        // Configuraci贸n STUN servers para WebRTC
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // Selecci贸n de avatar
        document.querySelectorAll('.avatar-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.avatar-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                option.classList.add('selected');
                selectedAvatar = option.getAttribute('data-avatar');
            });
        });

        // Registrar usuario
        function registerUser() {
            const userName = document.getElementById('userName').value.trim();
            if (!userName) {
                alert('Por favor ingresa tu nombre');
                return;
            }

            currentUser = {
                name: userName,
                avatar: selectedAvatar
            };

            // Conectar al servidor Socket.io
            socket = io();

            // Configurar event listeners del socket
            setupSocketListeners();

            // Registrar usuario en el servidor
            socket.emit('register', currentUser);

            // Mostrar pantalla de usuarios
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('usersScreen').style.display = 'block';
        }

        // Configurar listeners del socket
        function setupSocketListeners() {
            socket.on('users-update', (users) => {
                updateUsersList(users);
            });

            socket.on('incoming-call', async (data) => {
                showIncomingCall(data);
            });

            socket.on('call-started', (data) => {
                currentCall = data.callId;
                showCallScreen('Llamando...', 'Esperando respuesta...');
            });

            socket.on('call-accepted', async (data) => {
                await handleCallAccepted(data);
            });

            socket.on('call-rejected', (data) => {
                alert('Llamada rechazada');
                hideCallScreen();
            });

            socket.on('call-ended', () => {
                endCall();
            });

            socket.on('ice-candidate', (data) => {
                if (peerConnection) {
                    peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            });
        }

        // Actualizar lista de usuarios
        function updateUsersList(users) {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';

            users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.onclick = () => startCall(user.id);
                
                userCard.innerHTML = `
                    <div class="user-avatar">${user.avatar}</div>
                    <h3>${user.name}</h3>
                    <div class="status">En l铆nea</div>
                `;
                
                usersList.appendChild(userCard);
            });
        }

        // Iniciar llamada
        async function startCall(targetUserId) {
            try {
                // Obtener stream local
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true,
                    video: false 
                });

                // Crear conexi贸n peer
                peerConnection = new RTCPeerConnection(configuration);

                // Agregar stream local
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Obtener stream remoto
                peerConnection.ontrack = (event) => {
                    remoteStream = event.streams[0];
                    document.getElementById('remoteAudio').srcObject = remoteStream;
                };

                // Manejar ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit('ice-candidate', {
                            target: targetUserId,
                            candidate: event.candidate
                        });
                    }
                };

                // Crear oferta
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                // Enviar oferta al servidor
                socket.emit('call-user', {
                    targetId: targetUserId,
                    offer: offer
                });

                // Mostrar pantalla de llamada
                showCallScreen('Llamando...', 'Esperando respuesta...');

            } catch (error) {
                console.error('Error iniciando llamada:', error);
                alert('Error al acceder al micr贸fono');
            }
        }

        // Mostrar notificaci贸n de llamada entrante
        function showIncomingCall(data) {
            currentCall = data.callId;
            document.getElementById('callerName').textContent = `${data.caller.avatar} ${data.caller.name}`;
            document.getElementById('incomingCallNotification').style.display = 'block';
        }

        // Aceptar llamada
        async function acceptCall() {
            document.getElementById('incomingCallNotification').style.display = 'none';
            
            try {
                // Obtener stream local
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true,
                    video: false 
                });

                // Crear conexi贸n peer
                peerConnection = new RTCPeerConnection(configuration);

                // Agregar stream local
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Obtener stream remoto
                peerConnection.ontrack = (event) => {
                    remoteStream = event.streams[0];
                    document.getElementById('remoteAudio').srcObject = remoteStream;
                };

                // Manejar ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit('ice-candidate', {
                            target: socket.id, // Enviar al caller
                            candidate: event.candidate
                        });
                    }
                };

                // Establecer descripci贸n remota (offer del caller)
                await peerConnection.setRemoteDescription(socket.receivedOffer);

                // Crear respuesta
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                // Enviar respuesta al servidor
                socket.emit('accept-call', {
                    callId: currentCall,
                    answer: answer
                });

                // Mostrar pantalla de llamada
                showCallScreen('En llamada', 'Llamada en curso');
                startCallTimer();

            } catch (error) {
                console.error('Error aceptando llamada:', error);
                alert('Error al aceptar la llamada');
            }
        }

        // Manejar llamada aceptada
        async function handleCallAccepted(data) {
            await peerConnection.setRemoteDescription(data.answer);
            showCallScreen('En llamada', 'Llamada en curso');
            startCallTimer();
        }

        // Rechazar llamada
        function rejectCall() {
            socket.emit('reject-call', {
                callId: currentCall,
                reason: 'Usuario ocupado'
            });
            document.getElementById('incomingCallNotification').style.display = 'none';
            currentCall = null;
        }

        // Mostrar pantalla de llamada
        function showCallScreen(status, info) {
            document.getElementById('usersScreen').style.display = 'none';
            document.getElementById('callScreen').style.display = 'block';
            document.getElementById('callStatus').textContent = status;
            document.getElementById('callerInfo').textContent = info;
        }

        // Ocultar pantalla de llamada
        function hideCallScreen() {
            document.getElementById('callScreen').style.display = 'none';
            document.getElementById('usersScreen').style.display = 'block';
            stopCallTimer();
            currentCall = null;
        }

        // Iniciar temporizador de llamada
        function startCallTimer() {
            callStartTime = Date.now();
            timerInterval = setInterval(updateCallTimer, 1000);
        }

        // Actualizar temporizador
        function updateCallTimer() {
            const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('callTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Detener temporizador
        function stopCallTimer() {
            clearInterval(timerInterval);
            document.getElementById('callTimer').textContent = '00:00';
        }

        // Alternar silencio
        function toggleMute() {
            if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                audioTracks.forEach(track => {
                    track.enabled = !track.enabled;
                });
                
                const muteBtn = document.getElementById('muteBtn');
                muteBtn.classList.toggle('active', !audioTracks[0].enabled);
            }
        }

        // Finalizar llamada
        function endCall() {
            if (currentCall) {
                socket.emit('end-call', { callId: currentCall });
            }
            
            // Detener streams
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            // Cerrar conexi贸n peer
            if (peerConnection) {
                peerConnection.close();
            }
            
            hideCallScreen();
        }

        // Salir
        function logout() {
            if (socket) {
                socket.disconnect();
            }
            document.getElementById('usersScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
            currentUser = null;
        }

        // Al cargar la p谩gina, configurar el socket para recibir ofertas
        document.addEventListener('DOMContentLoaded', function() {
            // Guardar ofertas recibidas para cuando se acepte la llamada
            if (socket) {
                socket.on('incoming-call', (data) => {
                    socket.receivedOffer = data.offer;
                });
            }
        });
    </script>
</body>
</html>